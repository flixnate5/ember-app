
# Chapter 9
    Routes with dynamic segments
    Links with dynamic segments
    Component tests with access to the router
    Accessing parameters from dynamic segments
    Sharing common setup code between tests
# Chapter 10
    Splattributes and the class attribute
    The router service
    Ember services vs. global variables
    Mocking services in tests
# Chapter 11
    EmberData models
    Testing models
    Loading models in routes
    The EmberData store
    Working with adapters and serializers
# Chapter 12
    Using Ember's built-in <Input> component
    The provider component pattern
    Using block parameters when invoking components
    Yielding data to caller components
    


# Route Params
    
    Routes with dynamic segments
    Links with dynamic segments
    Component tests with access to the router
    Accessing parameters from dynamic segments
    Sharing common setup code between tests

## Routes with Dynamic Segments 
individual rental pages to be available through predictable URLs like /rentals/grand-old-mansion. 
we can show more detailed information about each property on this page. 
bookmark a rental property, and share direct links

app/router.js
```js

import EmberRouter from '@ember/routing/router';
import config from 'tutorial-app/config/environment';

export default class Router extends EmberRouter {
  location = config.locationType;
  rootURL = config.rootURL;
}

Router.map(function () {
  this.route('about');
  this.route('contact', { path: '/getting-in-touch' });
  this.route('rental', { path: '/rentals/:rental_id' });
});
```

Instead of using the default path (/rental), we're specifying a custom path. 


## Links with Dynamic Segments 
update our Rental component to actually link to each of our detailed rental properties!

app/components/rental.gjs
```gjs

import RentalImage from 'tutorial-app/components/rental/image';
import Map from 'tutorial-app/components/map';
import { LinkTo } from '@ember/routing';

<template>
  <article class="rental">
    <RentalImage
      src={{@rental.image}}
      alt="A picture of {{@rental.title}}"
    />
    <div class="details">
      <h3>
        <LinkTo @route="rental" @model={{@rental}}>
          {{@rental.title}}
        </LinkTo>
      </h3>
      <div class="detail owner">
        <span>Owner:</span> {{@rental.owner}}
      </div>
      <div class="detail type">
        <span>Type:</span> {{@rental.type}}
      </div>
      <div class="detail location">
        <span>Location:</span> {{@rental.city}}
      </div>
      <div class="detail bedrooms">
        <span>Number of bedrooms:</span> {{@rental.bedrooms}}
      </div>
    </div>
    <Map
      @lat={{@rental.location.lat}}
      @lng={{@rental.location.lng}}
      @zoom="9"
      @width="150"
      @height="150"
      alt="A map of {{@rental.title}}"
    />
  </article>
</template>
```

Thus, we need to pass in a `@model` argument so that the LinkTo component can generate the appropriate URL for that model.

The links are all pointing to `/rentals/undefined`. 
LinkTo tries to use the id property from our model in order to replace the dynamic segment and generate the URL.

our model doesn't actually have an id property

Our data do have an id attribute

So we have access to this data; the only trouble is that we're not including it in our model! 


app/routes/index.js
```js

import Route from '@ember/routing/route';

const COMMUNITY_CATEGORIES = ['Condo', 'Townhouse', 'Apartment'];

export default class IndexRoute extends Route {
  async model() {
    let response = await fetch('/api/rentals.json');
    let { data } = await response.json();

    return data.map((model) => {
      let { id, attributes } = model;
      let type;

      if (COMMUNITY_CATEGORIES.includes(attributes.category)) {
        type = 'Community';
      } else {
        type = 'Standalone';
      }

      return { id, type, ...attributes };
    });
  }
}
```
Now that we've included our model's id, we should see the correct URLs to each rental property on our index page after refreshing the page.

## Component Tests with Access to the Router 
We can add an id to the rental that we defined in our test using setProperties and add an assertion for the expected URL, too.

tests/integration/components/rental-test.gjs
```gjs

import { module, test } from 'qunit';
import { setupRenderingTest } from 'tutorial-app/tests/helpers';
import { render } from '@ember/test-helpers';
import Rental from 'tutorial-app/components/rental';
import { tracked } from '@glimmer/tracking';

module('Integration | Component | rental', function (hooks) {
  setupRenderingTest(hooks);

  test('it renders information about a rental property', async function (assert) {
    class State { 
      @tracked rental = {
        id: 'grand-old-mansion',
        title: 'Grand Old Mansion',
        owner: 'Veruca Salt',
        city: 'San Francisco',
        location: {
          lat: 37.7749,
          lng: -122.4194,
        },
        category: 'Estate',
        type: 'Standalone',
        bedrooms: 15,
        image:
          'https://upload.wikimedia.org/wikipedia/commons/c/cb/Crane_estate_(5).jpg',
        description:
          'This grand old mansion sits on over 100 acres of rolling hills and dense redwood forests.',
      };
    };

    const state = new State();

    await render(<template><Rental @rental={{state.rental}} /></template>);

    assert.dom('article').hasClass('rental');
    assert.dom('article h3').hasText('Grand Old Mansion');
    assert
      .dom('article h3 a')
      .hasAttribute('href', '/rentals/grand-old-mansion');
    assert.dom('article .detail.owner').includesText('Veruca Salt');
    assert.dom('article .detail.type').includesText('Standalone');
    assert.dom('article .detail.location').includesText('San Francisco');
    assert.dom('article .detail.bedrooms').includesText('15');
    assert.dom('article .image').exists();
    assert.dom('article .map').exists();
  });
});
```

## Accessing Parameters from Dynamic Segments 


app/routes/rental.js
```js

import Route from '@ember/routing/route';

const COMMUNITY_CATEGORIES = ['Condo', 'Townhouse', 'Apartment'];

export default class RentalRoute extends Route {
  async model(params) {
    let response = await fetch(`/api/rentals/${params.rental_id}.json`);
    let { data } = await response.json();

    let { id, attributes } = data;
    let type;

    if (COMMUNITY_CATEGORIES.includes(attributes.category)) {
      type = 'Community';
    } else {
      type = 'Standalone';
    }

    return { id, type, ...attributes };
  }
}
```


we have a params object being passed into our model hook. 
This is because we need to fetch our data from the `/api/rentals/${id}.json` 

 a `/:rental_id` dynamic segment to figure out which rental object we're trying to fetch from the server.

we have access to the value of the `/:rental_id` dynamic segment through the params object. 
 
Next, let's make a RentalDetailed component.

```shell

 ember generate component rental/detailed
```

app/components/rental/detailed.gjs
```gjs

import Jumbo from 'tutorial-app/components/jumbo';
import RentalImage from 'tutorial-app/components/rental/image';
import Map from 'tutorial-app/components/map';

<template>
  <Jumbo>
    <h2>{{@rental.title}}</h2>
    <p>Nice find! This looks like a nice place to stay near {{@rental.city}}.</p>
    <a href="#" target="_blank" rel="external nofollow noopener noreferrer" class="share button">
      Share on Twitter
    </a>
  </Jumbo>

  <article class="rental detailed">
    <RentalImage
      src={{@rental.image}}
      alt="A picture of {{@rental.title}}"
    />

    <div class="details">
      <h3>About {{@rental.title}}</h3>

      <div class="detail owner">
        <span>Owner:</span> {{@rental.owner}}
      </div>
      <div class="detail type">
        <span>Type:</span> {{@rental.type}} – {{@rental.category}}
      </div>
      <div class="detail location">
        <span>Location:</span> {{@rental.city}}
      </div>
      <div class="detail bedrooms">
        <span>Number of bedrooms:</span> {{@rental.bedrooms}}
      </div>
      <div class="detail description">
        <p>{{@rental.description}}</p>
      </div>
    </div>

    <Map
      @lat={{@rental.location.lat}}
      @lng={{@rental.location.lng}}
      @zoom="12"
      @width="894"
      @height="600"
      alt="A map of {{@rental.title}}"
      class="large"
    />
  </article>
</template>
```

This component is similar to our Rental component, except for the following differences.
 - It shows a banner with a share button at the top (Implementation to come later).
 - It shows a bigger image by default, with some additional detailed information.
 - It shows a bigger map.
 - It shows a description.

## Sharing Common Setup Code Between Tests 

tests/integration/components/rental/detailed-test.gjs

```gjs

import { module, test } from 'qunit';
import { setupRenderingTest } from 'tutorial-app/tests/helpers';
import { render } from '@ember/test-helpers';
import { tracked } from '@glimmer/tracking';
import RentalDetailed from 'tutorial-app/components/rental/detailed';

class State {
  @tracked rental = {};
}

const state = new State();

module('Integration | Component | rental/detailed', function (hooks) {
  setupRenderingTest(hooks);

  hooks.beforeEach(function () {
    state.rental = {
      id: 'grand-old-mansion',
      title: 'Grand Old Mansion',
      owner: 'Veruca Salt',
      city: 'San Francisco',
      location: {
        lat: 37.7749,
        lng: -122.4194,
      },
      category: 'Estate',
      type: 'Standalone',
      bedrooms: 15,
      image:
        'https://upload.wikimedia.org/wikipedia/commons/c/cb/Crane_estate_(5).jpg',
      description:
        'This grand old mansion sits on over 100 acres of rolling hills and dense redwood forests.',
    };
  });

  test('it renders a header with a share button', async function (assert) {
    await render(<template>
      <RentalDetailed @rental={{state.rental}} />
    </template>);

    assert.dom().hasText('');
    assert.dom('.jumbo').exists();
    assert.dom('.jumbo h2').containsText('Grand Old Mansion');
    assert
      .dom('.jumbo p')
      .containsText('a nice place to stay near San Francisco');
    assert.dom('.jumbo a.button').containsText('Share on Twitter');
  });

    // Template block usage:
  test('it renders detailed information about a rental property', async function (assert) {
    await render(<template>
      <RentalDetailed @rental={{state.rental}} />
    </template>);

    assert.dom('article').hasClass('rental');
    assert.dom('article h3').containsText('About Grand Old Mansion');
    assert.dom('article .detail.owner').containsText('Veruca Salt');
    assert.dom('article .detail.type').containsText('Standalone – Estate');
    assert.dom('article .detail.location').containsText('San Francisco');
    assert.dom('article .detail.bedrooms').containsText('15');
    assert.dom('article .image').exists();
    assert.dom('article .map').exists();
  });
});
```

We can use the `beforeEach hook` to share some boilerplate code, which allows us to have two tests that each focus on a different, single aspect of the component. 

the beforeEach hook runs once before each test function is executed. 
ideal place to set up anything that might be needed by all test cases in the file. 
On the other hand, if you need to do any cleanup after your tests, there is an `afterEach` hook!


# Adding a Route Template 
Finally, let's add a rental template to actually invoke our <RentalDetailed> component, as well as adding an acceptance test for this new behavior in our app.

app/templates/rental.gjs
```gjs

import RentalDetailed from 'tutorial-app/components/rental/detailed';

<template>
  <RentalDetailed @rental={{@model}} />
</template>
```

tests/acceptance/super-rentals-test.js
```js

import { module, test } from 'qunit';
import { click, visit, currentURL } from '@ember/test-helpers';
import { setupApplicationTest } from 'tutorial-app/tests/helpers';

module('Acceptance | super rentals', function (hooks) {
  setupApplicationTest(hooks);

  test('visiting /', async function (assert) {
    await visit('/');

    assert.strictEqual(currentURL(), '/');
    assert.dom('nav').exists();
    assert.dom('h1').hasText('SuperRentals');
    assert.dom('h2').hasText('Welcome to Super Rentals!');

    assert.dom('.jumbo a.button').hasText('About Us');
    await click('.jumbo a.button');

    assert.strictEqual(currentURL(), '/about');
  });

  test('viewing the details of a rental property', async function (assert) {
    await visit('/');
    assert.dom('.rental').exists({ count: 3 });

    await click('.rental:first-of-type a');
    assert.strictEqual(currentURL(), '/rentals/grand-old-mansion');
  });

  test('visiting /rentals/grand-old-mansion', async function (assert) {
    await visit('/rentals/grand-old-mansion');

    assert.strictEqual(currentURL(), '/rentals/grand-old-mansion');
    assert.dom('nav').exists();
    assert.dom('h2').containsText('Grand Old Mansion');
    assert.dom('.rental.detailed').exists();
  });

  test('visiting /about', async function (assert) {
    await visit('/about');

    assert.strictEqual(currentURL(), '/about');
    assert.dom('nav').exists();
    assert.dom('h1').hasText('SuperRentals');
    assert.dom('h2').hasText('About Super Rentals');

    assert.dom('.jumbo a.button').hasText('Contact Us');
    await click('.jumbo a.button');

    assert.strictEqual(currentURL(), '/getting-in-touch');
  });

  test('visiting /getting-in-touch', async function (assert) {
    await visit('/getting-in-touch');

    assert.strictEqual(currentURL(), '/getting-in-touch');
    assert.dom('nav').exists();
    assert.dom('h1').hasText('SuperRentals');
    assert.dom('h2').hasText('Contact Us');

    assert.dom('.jumbo a.button').hasText('About');
    await click('.jumbo a.button');

    assert.strictEqual(currentURL(), '/about');
  });

  test('navigating using the nav-bar', async function (assert) {
    await visit('/');

    assert.dom('nav').exists();
    assert.dom('nav a.menu-index').hasText('SuperRentals');
    assert.dom('nav a.menu-about').hasText('About');
    assert.dom('nav a.menu-contact').hasText('Contact');

    await click('nav a.menu-about');
    assert.strictEqual(currentURL(), '/about');

    await click('nav a.menu-contact');
    assert.strictEqual(currentURL(), '/getting-in-touch');

    await click('nav a.menu-index');
    assert.strictEqual(currentURL(), '/');
  });
});
```

